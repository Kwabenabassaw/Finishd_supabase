rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is accessing their own document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Allow read for any authenticated user (to view profiles, find friends, etc.)
      allow read: if isAuthenticated();
      // Allow update only if it's the owner
      allow update: if isOwner(userId);
      // Allow create if authenticated (for signup)
      allow create: if isAuthenticated() && isOwner(userId);
      
      // Subcollections
      
      // Followers: 
      // - Read: Allow anyone authenticated (to see who follows whom)
      // - Write: Allow if the document ID in the subcollection matches the requestor's UID 
      //   (i.e., I can add myself as a follower to someone else)
      match /followers/{followerId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(followerId);
      }
      
      // Following:
      // - Read: Allow anyone authenticated
      // - Write: Allow if the parent user ID matches the requestor's UID
      //   (i.e., I can add someone to my following list)
      match /following/{followingId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }

      // Movie Lists (finished, watching, watchlist, favorites)
      match /finished/{movieId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
      match /watching/{movieId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
      match /watchlist/{movieId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
      match /favorites/{movieId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
    }

    // Movies collection (for caching ratings)
    match /movies/{movieId}/ratings/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Feed cache collection (for personalized feed caching)
    match /feed_cache/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }
    // Chats collection
    match /chats/{chatId} {
      // Allow read if document doesn't exist (to check existence) OR if user is a participant
      allow read: if request.auth != null && (resource == null || request.auth.uid in resource.data.participants);
      allow create: if request.auth != null && request.resource.data.participants is list && request.auth.uid in request.resource.data.participants;
      allow update: if request.auth != null && request.auth.uid in resource.data.participants;

      match /messages/{messageId} {
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants && request.resource.data.senderId == request.auth.uid;
      }
    }
  }
}
